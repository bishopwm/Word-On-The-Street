<div class="hero-unit">
	<div class="hero-hugs">
	</div>
</div>

<hr />

<div class ="insta-map-wrapper">
	<div class="well insta-bar">
		<ul class="instas-list"><strong>What's Happening Nearby?</strong>
			<% @instas.each do |insta| %>
			<% next if insta['location_name'].nil? %>

			<li class="insta-list-item"><br />
				<img src="<%= insta['image']['url'] %>" class="insta-pic">
			</li>
			<li class="insta-list-item"><strong>Hashtags: </strong><br />
				<%= insta['hashtag'].to_s.gsub!(/\W/,' ') %>
			</li>

			<li class="insta-list-item"><strong>Location: </strong><br />
				<%= insta['location_name'] %>
			</li>
			<li class="insta-list-item"><strong>Coordinates: </strong><br />
				<%= insta['coordinates'].to_s %>
			</li>

			<br />
				<% end %>
		</ul>
	</div>
	<div id="map"></div>
</div>




<div class = "well">
<form>
  <div class="form-group">
    <label for="new-search">New Search</label>
    <input type="text" class="form-control" name="q" id="new-search" placeholder="Enter Nationality">
    <input type="hidden" class="form-control" name="latitude" id="lat">
    <input type="hidden" class="form-control" name="longitude" id="lon">
  </div>
  <button type="submit" class="btn btn-default">Submit</button>
</form>

</div>

<script type="text/javascript">

	$(function () {
		$('#lat').val(localStorage.getItem('latitude'));
		$('#lon').val(localStorage.getItem('longitude'));
		
		var map = L.map('map').setView([<%= @latitude %>, <%= @longitude %>], 14);
		var currentLocation = [<%= @latitude %>, <%= @longitude %>];


		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={access_token}', {
		    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		    maxZoom: 18,
		    id: "<%= ENV['mapbox_id'] %>",
		    access_token: "<%= ENV['mapbox_access_token'] %>"
		}).addTo(map);	

		map.scrollWheelZoom.disable();

		var markersYelp = {}
		var markersMeetup = {}
		var markersInsta = {}

		var currentLocationIcon = L.icon({
		    iconUrl: '/assets/star.png',
		    iconSize: [70, 40],
		    iconAnchor: [22, 64],
		    popupAnchor: [-3, -76]	
		});
		var currentLocationMarker = L.marker(currentLocation, {icon: currentLocationIcon}).addTo(map);
		var currentLocationContent = '<h4>You Are Here</h4>'
		currentLocationMarker.bindPopup(currentLocationContent);

		var meetupIcon = L.icon({
		    iconUrl: '/assets/Meetup_Logo.png',
		    iconSize: [55, 40],
		    iconAnchor: [22, 64],
		    popupAnchor: [-3, -76]
		});

		var yelpIcon = L.icon({
			iconUrl: '/assets/Yelp_Logo.png',
			iconSize: [55, 40],
		    iconAnchor: [22, 64],
		    popupAnchor: [-3, -76]			
		});
		var instaIcon = L.icon({
			iconUrl: '/assets/insta.png',
			iconSize: [45, 30],
		    iconAnchor: [22, 64],
		    popupAnchor: [-3, -76]			
		});


		//Yelp Content
		var popupContentsYelp = {}



		<% @businesses.each_with_index do |business, index| %>
			<% if current_user %>
				popupContentsYelp["popup" + <%= index %>] = "<h3><%= escape_javascript business[:name].to_s %></h3><p><strong>Address: <br /></strong><%=escape_javascript business[:address].to_s.gsub!(/\W/,' ')%></p><p><strong>Coordinates: <br /></strong><%=escape_javascript business[:coordinates].to_s%></p><p><strong>Recent Tweets: <br /></strong><%=escape_javascript @tweets[0] %></p><p><form method='POST' action='/streetwords'><input type='hidden' name='authenticity_token' value='<%= form_authenticity_token %>'><input type='hidden' value='<%= business[:name] %>' name='streetword[name]'><input type='hidden' value='<%= business[:latitude] %>' name='streetword[latitude]' ><input type='hidden' value='<%= business[:longitude] %>' name='streetword[longitude]'><input type='hidden' value='<%= business[:address] %>' name='streetword[address]'><button type='submit' class='btn btn-default'>Save</button></form></p>"
			<% else %>
				popupContentsYelp["popup" + <%= index %>] = "<h3><%= escape_javascript business[:name].to_s %></h3><p><strong>Address: <br /></strong><%=escape_javascript business[:address].to_s.gsub!(/\W/,' ')%></p><p><strong>Coordinates: <br /></strong><%=escape_javascript business[:coordinates].to_s%></p><p><strong>Recent Tweets: <br /></strong><%=escape_javascript @tweets[0].to_s.gsub!(/\W/,' ') %></p>"
			<% end %>

		// document.getElementById('address').value = <%= business[:address] %>;
		// document.getElementById('name').value = <%= business[:name] %>;
 				

			markersYelp["marker" + <%= index %>] = L.marker(<%= business[:coordinates] %>, {icon: yelpIcon}).bindPopup(popupContentsYelp['popup' + <%= index %>]).addTo(map);
		<% end %>


	
		//Meetup Content
		var popupContentsMeetup = {}

		<% @meetups.each_with_index do |meetup, index| %>
			popupContentsMeetup["popup" + <%= index %>] = '<h3><%=escape_javascript meetup["event"]%></h3>'
			markersMeetup["marker" + <%= index %>] = L.marker(<%= meetup["coordinates"] %>, {icon: meetupIcon}).bindPopup(popupContentsMeetup['popup' + <%= index %>]).addTo(map);
		<% end %>

		//Insta Content
		var popupContentsInsta = {}

		<% @instas.each_with_index do |insta, index| %>
			popupContentsInsta["popup" + <%= index %>] = "<p><img src='<%=escape_javascript insta['image']['url']%>'class='instapopup'></p><p>Hashtags: <%=escape_javascript insta['hashtag'].to_s.gsub!(/\W/,' ') %></p><p>Location: <%=escape_javascript insta['location_name'] %></p>"
			markersInsta["marker" + <%= index %>] = L.marker(<%= insta["coordinates"] %>, {icon: instaIcon}).bindPopup(popupContentsInsta['popup' + <%= index %>]).addTo(map);
		<% end %>


		function goTo($el) {
		    $('html, body').animate({
		        scrollTop: $el.offset().top + 'px'
		    }, 'slow');
		    return $el;
	    }

	    goTo($('#map'));

	})

</script>
