
<div id="map"></div>

<script type="text/javascript">

	$(function () {
		document.addEventListener("LocationLoaded", function() {
		  addTo(map);
		});
		
		var map = L.map('map').setView([<%= @latitude %>, <%= @longitude %>], 13);
		var currentLocation = [<%= @latitude %>, <%= @longitude %>];


		L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
		    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
		    maxZoom: 18,
		    id: 'wbishop231.n15g88p3',
		    accessToken: 'pk.eyJ1Ijoid2Jpc2hvcDIzMSIsImEiOiJlNjdmZWQ5NWMwMjdmOTNiNjJiZTY0ZTdmZTVlOWY0OSJ9.11weNx-x_-nmTstxP9Kq6g'
		}).addTo(map);	

		var markers = {}
		var popupContents = {}
		var currentLocationMarker = L.marker(currentLocation).addTo(map);

		<% @businesses.each_with_index do |business, index| %>
			popupContents["popup" + <%= index %>] = '<h3><%=escape_javascript business[:name].to_s %></h3><p><%=escape_javascript business[:address].to_s %></p>'
			markers["marker" + <%= index %>] = L.marker(<%= business[:coordinates] %>).bindPopup(popupContents['popup' + <%= index %>]).addTo(map);
		<% end %>
	

	})

</script>
